<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clickable Ternary — Grid Approach</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background:#f3f5f9; color:#222; margin:24px; display:flex; flex-direction:column; align-items:center; }
  h1 { margin:6px 0 12px; }
  .container { display:flex; gap:20px; flex-wrap:wrap; justify-content:center; max-width:1200px; }
  .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.07); width:480px; text-align:center; }
  #plot-present, #plot-future { width:100%; height:420px; }
  .values{ margin-top:10px; font-weight:600; }
  button { margin-top:18px; background:#007bff; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
  footer{ margin-top:20px; color:#666; font-size:13px; }
</style>
</head>
<body>
  <h1>Values Survey — Present Day vs Year 2075</h1>
  <p style="max-width:900px;text-align:center;color:#555;">Click anywhere inside a triangle to set percentages for Economic Growth, Health &amp; Wellbeing, and Care for Climate. (This uses an invisible grid of clickable points for a reliable experience.)</p>

  <div class="container">
    <div class="card">
      <h3 style="color:#007bff;margin-bottom:8px;">Present Day</h3>
      <div id="plot-present"></div>
      <div class="values" id="valuesPresent">Selected Values: —</div>
    </div>

    <div class="card">
      <h3 style="color:#28a745;margin-bottom:8px;">Year 2075</h3>
      <div id="plot-future"></div>
      <div class="values" id="valuesFuture">Selected Values: —</div>
    </div>
  </div>

  <form id="surveyForm" action="https://formspree.io/f/YOUR_FORM_ID" method="POST" style="width:100%;max-width:1200px;text-align:center;">
    <!-- present -->
    <input type="hidden" name="economic_present" id="econPresent">
    <input type="hidden" name="health_present" id="healthPresent">
    <input type="hidden" name="climate_present" id="climatePresent">
    <!-- future -->
    <input type="hidden" name="economic_future" id="econFuture">
    <input type="hidden" name="health_future" id="healthFuture">
    <input type="hidden" name="climate_future" id="climateFuture">

    <button type="submit">Submit Both Responses</button>
  </form>

  <footer>© 2025 Digital Society Project</footer>

<script>
/*
  Grid-click ternary solution:
  - Build a dense grid of ternary points (a,b,c) that sum to 100.
  - Make this a trace with markers that are invisible (opacity 0) but clickable.
  - Add a second trace that shows the selected point (visible marker).
  - Clicking any grid point triggers a 'plotly_click' and we update the selected trace and form values.
*/

function buildGridPoints(stepPercent = 4) {
  // stepPercent determines the grid resolution. Smaller -> finer but more points.
  const aArr = [], bArr = [], cArr = [];
  for (let a = 0; a <= 100; a += stepPercent) {
    for (let b = 0; b <= 100 - a; b += stepPercent) {
      const c = 100 - a - b;
      // push point (we allow points where c may be fractional due to floating math but they sum to ~100)
      aArr.push(Number(a.toFixed(2)));
      bArr.push(Number(b.toFixed(2)));
      cArr.push(Number(c.toFixed(2)));
    }
  }
  return { aArr, bArr, cArr };
}

function createTernary(plotId, displayId, econInput, healthInput, climateInput, pointColor) {
  const resolutionStep = 2; // change to 1 for finer grid (more points); 2 is already fine and performant
  const grid = buildGridPoints(resolutionStep);

  // Invisible grid trace (clickable)
  const gridTrace = {
    type: 'scatterternary',
    mode: 'markers',
    a: grid.aArr,
    b: grid.bArr,
    c: grid.cArr,
    marker: {
      size: 14,        // bigger size makes clicks easier
      color: 'rgba(0,0,0,0)', // invisible
      line: { width: 0 }
    },
    hoverinfo: 'none',
    showlegend: false
  };

  // Visible selected point (starts neutral)
  const selectedTrace = {
    type: 'scatterternary',
    mode: 'markers',
    a: [33.3],
    b: [33.3],
    c: [33.4],
    marker: {
      color: pointColor,
      size: 14,
      symbol: 'circle'
    },
    hoverinfo: 'text',
    text: ['Economic: 33.3, Health: 33.3, Climate: 33.4'],
    showlegend: false
  };

  const layout = {
    ternary: {
      sum: 100,
      aaxis: { title: 'Economic Growth' },
      baxis: { title: 'Health & Wellbeing' },
      caxis: { title: 'Care for Climate' }
    },
    margin: { t: 40, l: 40, r: 40, b: 40 },
    paper_bgcolor: '#fff'
  };

  Plotly.newPlot(plotId, [gridTrace, selectedTrace], layout, {responsive: true});

  const plotDiv = document.getElementById(plotId);
  const display = document.getElementById(displayId);

  function updateSelected(aPct, bPct, cPct) {
    // normalize to sum 100 (float rounding may create tiny drift)
    let a = parseFloat(aPct), b = parseFloat(bPct), c = parseFloat(cPct);
    const s = a + b + c || 1;
    a = (a / s * 100);
    b = (b / s * 100);
    c = (c / s * 100);
    const aStr = a.toFixed(1), bStr = b.toFixed(1), cStr = c.toFixed(1);

    display.innerHTML = `Selected Values:<br> Economic Growth: ${aStr}% &nbsp; | &nbsp; Health & Wellbeing: ${bStr}% &nbsp; | &nbsp; Care for Climate: ${cStr}%`;
    document.getElementById(econInput).value = aStr;
    document.getElementById(healthInput).value = bStr;
    document.getElementById(climateInput).value = cStr;

    // update visible marker
    Plotly.restyle(plotDiv, {
      'a': [[aStr]],
      'b': [[bStr]],
      'c': [[cStr]],
      'text': [[`Economic: ${aStr}, Health: ${bStr}, Climate: ${cStr}`]]
    }, [1]); // update the selectedTrace (trace index 1)
  }

  // initialize display and inputs with neutral values
  updateSelected(33.3, 33.3, 33.4);

  // Listen for clicks on points in the grid trace. Plotly will fire plotly_click for the clicked grid point.
  plotDiv.on('plotly_click', function(event) {
    if (!event || !event.points || event.points.length === 0) return;
    const pt = event.points[0];
    if (typeof pt.a === 'undefined') return;

    // pt.a, pt.b, pt.c are the ternary values for the clicked (grid) point
    updateSelected(pt.a, pt.b, pt.c);
  });

  // Return a function that allows external setting if needed
  return {
    set: updateSelected
  };
}

// Create both plots
const present = createTernary('plot-present', 'valuesPresent', 'econPresent', 'healthPresent', 'climatePresent', '#007bff');
const future  = createTernary('plot-future',  'valuesFuture',  'econFuture',  'healthFuture',  'climateFuture',  '#28a745');

// Form guard
document.getElementById('surveyForm').addEventListener('submit', function(e){
  if (!document.getElementById('econPresent').value || !document.getElementById('econFuture').value) {
    e.preventDefault();
    alert('Please click inside both triangles to select your values before submitting.');
  }
});
</script>
</body>
</html>
